name: 'Sync with OpenClaw Upstream'

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
      # ä½¿ç”¨åˆšåˆšè®¾ç½®çš„ UPDATEï¼Œèµ‹äºˆå®ƒä¿®æ”¹ Workflow æ–‡ä»¶çš„æƒé™
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.UPDATE }}
          
      # æ­¥éª¤2ï¼šé…ç½®Git
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global pull.rebase false
          
      # æ­¥éª¤3ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥
      - name: Sync from OpenClaw upstream
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git
          
          echo "æ­£åœ¨è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°..."
          git fetch upstream main
          
          echo "æ­£åœ¨åˆå¹¶åˆ°æœ¬åœ°åˆ†æ”¯..."
          git checkout main
          
          if git merge upstream/main --no-edit --no-ff; then
            echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ¨é€æ›´æ–°..."
            
            # ä½¿ç”¨ Token é‡æ–°è®¾ç½® origin URLï¼Œç¡®ä¿æœ‰æƒé™æ¨é€ workflows æ–‡ä»¶å¤¹çš„ä¿®æ”¹
            # æ ¼å¼ï¼šhttps://oauth2:TOKEN@github.com/ç”¨æˆ·å/ä»“åº“å.git
            git remote set-url origin https://oauth2:${{ secrets.ACTION_TOKEN }}@github.com/${{ github.repository }}.git
            
            if git push origin main; then
              echo "ğŸ‰ åŒæ­¥å®Œæˆï¼Forkå·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ACTION_TOKEN æ˜¯å¦é…ç½®æ­£ç¡®"
              exit 1
            fi
          else
            echo "âš ï¸ åˆå¹¶å‘ç”Ÿå†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
            git merge --abort
            exit 1
          fi
